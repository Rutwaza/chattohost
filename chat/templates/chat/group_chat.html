<h1>Group: {{ group.name }}</h1>
<div id="messages">
{% for m in messages %}
    <p><strong>{{ m.user.username }}:</strong> {{ m.content }}
    {% if m.user == user or user == group.admin %}
        <a href="{% url 'chat:delete_message' group.id m.id %}">Delete</a>
    {% endif %}
    </p>
{% endfor %}
</div>
<div id="typingIndicator"></div>

<input type="text" id="msgInput" placeholder="Type a message..." autocomplete="off"/>
<button id="sendBtn">Send</button>

<script>
const groupId = {{ group.id }};
const wsScheme = window.location.protocol === "https:" ? "wss" : "ws";
const chatSocket = new WebSocket(`${wsScheme}://${window.location.host}/ws/group/${groupId}/`);

const msgInput = document.getElementById("msgInput");
const sendBtn = document.getElementById("sendBtn");
const messagesDiv = document.getElementById("messages");
const typingIndicator = document.getElementById("typingIndicator");

// Send message
sendBtn.onclick = () => {
    if (msgInput.value.trim() !== "") {
        chatSocket.send(JSON.stringify({
            'message': msgInput.value
        }));
        msgInput.value = '';
    }
}

// Typing indicator
let typingTimeout;
msgInput.addEventListener('input', () => {
    chatSocket.send(JSON.stringify({'typing': true}));
    clearTimeout(typingTimeout);
    typingTimeout = setTimeout(() => {
        chatSocket.send(JSON.stringify({'typing': false}));
    }, 1000);
});

// Receive messages
chatSocket.onmessage = function(e) {
    const data = JSON.parse(e.data);
    if (data.message) {
        const p = document.createElement('p');
        p.innerHTML = `<strong>${data.username}:</strong> ${data.message}`;
        messagesDiv.appendChild(p);
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }
    if (data.typing !== undefined) {
        typingIndicator.textContent = data.typing ? `${data.username} is typing...` : '';
    }
};
</script>
