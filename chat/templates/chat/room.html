<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enhanced Secret Chat Room</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background: linear-gradient(135deg, #0f0c29, #302b63, #24243e);
            min-height: 100vh;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            color: #e6e6e6;
        }

        .container {
            width: 90%;
            max-width: 1200px;
            background-color: rgba(18, 18, 30, 0.9);
            border-radius: 16px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.4);
            overflow: hidden;
            margin-top: 20px;
            border: 1px solid #39394d;
        }

        .header {
            background: linear-gradient(to right, #5433FF, #20BDFF, #A5FECB);
            color: white;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            position: relative;
        }

        .header::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: linear-gradient(to right, transparent, rgba(255,255,255,0.5), transparent);
        }

        .header h2 {
            font-weight: 600;
            font-size: 1.8rem;
            text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.3);
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(45deg, #5433FF, #20BDFF);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 18px;
        }

        .header-actions {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .logout-btn {
            background: linear-gradient(to right, #ff416c, #ff4b2b);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 20px;
            text-decoration: none;
            font-weight: 500;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .logout-btn:hover {
            background: linear-gradient(to right, #ff4b2b, #ff416c);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(255, 75, 43, 0.4);
        }

        .status-bar {
            background-color: #1a1a2e;
            padding: 12px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #2d2d4d;
        }

        #presence-count {
            font-weight: 600;
            color: #20BDFF;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        #presence-count::before {
            content: "";
            display: inline-block;
            width: 10px;
            height: 10px;
            background-color: #4CAF50;
            border-radius: 50%;
            box-shadow: 0 0 8px #4CAF50;
        }

        .clear-chat-btn {
            background: linear-gradient(to right, #ff416c, #ff4b2b);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .clear-chat-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(255, 75, 43, 0.3);
        }

        #chat-container {
            display: flex;
            flex-direction: column;
            height: 600px;
        }

        #chat-log {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            background-color: #13131f;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .message {
            display: flex;
            flex-direction: column;
            max-width: 80%;
            animation: fadeIn 0.4s ease;
        }

        .message.received {
            align-self: flex-start;
        }

        .message.sent {
            align-self: flex-end;
        }

        .message-content {
            padding: 12px 16px;
            border-radius: 18px;
            margin-bottom: 5px;
            position: relative;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            max-width: 100%;
            word-wrap: break-word;
        }

        .message.received .message-content {
            background: linear-gradient(to right, #2c2c54, #40407a);
            border-top-left-radius: 4px;
            border-bottom-left-radius: 4px;
        }

        .message.sent .message-content {
            background: linear-gradient(to right, #5433FF, #20BDFF);
            color: white;
            border-top-right-radius: 4px;
            border-bottom-right-radius: 4px;
        }

        .message-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            padding: 0 5px;
        }

        .username {
            font-weight: 600;
            font-size: 0.9rem;
        }

        .message.received .username {
            color: #A5FECB;
        }

        .message.sent .username {
            color: #20BDFF;
        }

        .timestamp {
            font-size: 0.75rem;
            color: #aaa;
        }

        .message-image {
            margin-top: 10px;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
            max-width: 300px;
        }

        .message-image img {
            max-width: 100%;
            max-height: 250px;
            width: auto;
            height: auto;
            display: block;
            object-fit: contain;
        }

        #chat-form {
            display: flex;
            padding: 20px;
            background-color: #1a1a2e;
            border-top: 1px solid #2d2d4d;
            gap: 12px;
            align-items: center;
        }

        #chat-input {
            flex: 1;
            padding: 15px 20px;
            border: 1px solid #39394d;
            border-radius: 24px;
            outline: none;
            font-size: 1rem;
            transition: all 0.3s;
            background-color: #25253e;
            color: #e6e6e6;
            resize: none;
            min-height: 50px;
            max-height: 150px;
            overflow-y: auto;
        }

        #chat-input:focus {
            border-color: #5433FF;
            box-shadow: 0 0 0 2px rgba(84, 51, 255, 0.3);
        }

        .file-upload {
            position: relative;
            display: flex;
            align-items: center;
        }

        .file-upload-label {
            background: linear-gradient(to right, #5433FF, #20BDFF);
            color: white;
            padding: 13px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
            width: 50px;
            height: 50px;
        }

        .file-upload-label:hover {
            transform: rotate(15deg);
            box-shadow: 0 4px 8px rgba(32, 189, 255, 0.3);
        }

        #chat-image {
            position: absolute;
            opacity: 0;
            width: 0.1px;
            height: 0.1px;
            overflow: hidden;
            z-index: -1;
        }

        #chat-form button {
            background: linear-gradient(to right, #5433FF, #20BDFF);
            color: white;
            border: none;
            padding: 15px 25px;
            border-radius: 24px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        #chat-form button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(32, 189, 255, 0.3);
        }

        #chat-form button:active {
            transform: translateY(0);
        }

        .welcome-text {
            text-align: center;
            margin: 15px 0;
            color: white;
            font-size: 1.3rem;
            text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.3);
            font-weight: 300;
        }

        .welcome-text span {
            color: #20BDFF;
            font-weight: 600;
        }

        /* Image preview styling */
        .image-preview-container {
            padding: 10px 20px;
            background-color: #1a1a2e;
            border-bottom: 1px solid #2d2d4d;
            display: none;
        }

        .image-preview {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .image-preview img {
            max-width: 100px;
            max-height: 100px;
            border-radius: 8px;
            border: 2px solid #5433FF;
        }

        .preview-cancel {
            background: #ff4757;
            color: white;
            border: none;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(15px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Scrollbar styling */
        #chat-log::-webkit-scrollbar {
            width: 8px;
        }

        #chat-log::-webkit-scrollbar-track {
            background: #1a1a2e;
        }

        #chat-log::-webkit-scrollbar-thumb {
            background: linear-gradient(to bottom, #5433FF, #20BDFF);
            border-radius: 4px;
        }

        #chat-log::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(to bottom, #20BDFF, #A5FECB);
        }

        /* Message status indicators */
        .message-status {
            display: flex;
            justify-content: flex-end;
            padding: 0 5px;
            font-size: 0.7rem;
            color: #666;
        }

        .message.sent .message-status {
            color: #20BDFF;
        }

        /* Responsive design */
        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                text-align: center;
                gap: 15px;
            }
            
            .header-actions {
                justify-content: center;
            }
            
            .message {
                max-width: 90%;
            }
            
            .message-image {
                max-width: 200px;
            }
            
            .message-image img {
                max-height: 180px;
            }
            
            #chat-form {
                flex-wrap: wrap;
            }
            
            #chat-input {
                min-width: 100%;
                order: 1;
            }
            
            .file-upload {
                order: 2;
            }
            
            #chat-form button {
                order: 3;
                flex: 1;
            }
            
            .container {
                border-radius: 12px;
            }
        }
    </style>
</head>
<body>
    <h2>Welcome <span>{{ request.user.username }}</span></h2>
    <p class="welcome-text">You're in the <span>secret</span> chat room!</p>
    
    <div class="container">
        <div class="header">
            <div class="user-info">
                <div class="avatar">{{ request.user.username|first|upper }}</div>
                <h2>Secret Chat Room</h2>
            </div>
            <div class="header-actions">
                <a href="{% url 'chat:logout' %}" class="logout-btn">
                    <i class="fas fa-sign-out-alt"></i> Logout
                </a>
            </div>
        </div>
        
        <div class="status-bar">
            <div id="presence-count">Online: 0</div>
            {% if request.user.is_superuser %}
            <form method="post" action="{% url 'chat:clear_chat' %}">
                {% csrf_token %}
                <button type="submit" class="clear-chat-btn">
                    <i class="fas fa-trash"></i> Clear Chat
                </button>
            </form>
            {% endif %}
        </div>
        
        
        <div id="chat-container">
            <div id="chat-log">
                {% for msg in messages %}
                <div class="message {% if msg.user.username == request.user.username %}sent{% else %}received{% endif %}">
                    <div class="message-header">
                        <span class="username">{{ msg.user.username }}</span>
                        <span class="timestamp">{{ msg.timestamp|date:"H:i" }}</span>
                    </div>
                    <div class="message-content">
                        {% if msg.text %}{{ msg.text|escape }}{% endif %}
                        {% if msg.image %}
                        <div class="message-image">
                            <img src="{{ msg.image.url }}">
                        </div>
                        {% endif %}
                    </div>
                    {% if msg.user.username == request.user.username %}
                    <div class="message-status">
                        <i class="fas fa-check-double"></i>
                    </div>
                    {% endif %}
                </div>
                {% endfor %}
            </div>
            <!-- Image preview container -->
        <div class="image-preview-container" id="image-preview-container">
            <div class="image-preview">
                <img id="preview-image" src="" alt="Preview">
                <span id="preview-filename"></span>
                <button class="preview-cancel" id="cancel-preview">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        </div>
            
            <form id="chat-form">
                <textarea id="chat-input" placeholder="Type a message..." autocomplete="off" rows="1"></textarea>
                <div class="file-upload">
                    <label for="chat-image" class="file-upload-label" title="Upload image">
                        <i class="fas fa-paperclip"></i>
                    </label>
                    <input type="file" id="chat-image" accept="image/*" />
                </div>
                <button type="submit">
                    <i class="fas fa-paper-plane"></i> Send
                </button>
            </form>
        </div>
    </div>

    <script>
        const roomName = "main_room";
        const wsScheme = window.location.protocol === "https:" ? "wss" : "ws";
        const chatSocket = new WebSocket(`${wsScheme}://${window.location.host}/ws/chat/`);

        const messagesDiv = document.getElementById("chat-log");
        const form = document.getElementById("chat-form");
        const input = document.getElementById("chat-input");
        const imageInput = document.getElementById("chat-image");
        const previewContainer = document.getElementById("image-preview-container");
        const previewImage = document.getElementById("preview-image");
        const previewFilename = document.getElementById("preview-filename");
        const cancelPreview = document.getElementById("cancel-preview");

        // Restore scroll position after refresh
        window.addEventListener('load', () => {
            const savedScrollPosition = localStorage.getItem('chatScrollPosition');
            if (savedScrollPosition) {
                messagesDiv.scrollTop = savedScrollPosition;
            } else {
                messagesDiv.scrollTop = messagesDiv.scrollHeight;
            }
        });

        // Save scroll position before refresh
        window.addEventListener('beforeunload', () => {
            localStorage.setItem('chatScrollPosition', messagesDiv.scrollTop);
        });

        // Auto-adjust textarea height
        input.addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = (this.scrollHeight) + 'px';
            
            // Limit to max height
            if (this.scrollHeight > 150) {
                this.style.overflowY = 'auto';
            } else {
                this.style.overflowY = 'hidden';
            }
        });

        // Image preview functionality
        imageInput.addEventListener('change', function(e) {
            if (this.files && this.files[0]) {
                const file = this.files[0];
                
                // Check if file is an image
                if (!file.type.match('image.*')) {
                    alert('Please select an image file');
                    this.value = '';
                    return;
                }
                
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    previewImage.src = e.target.result;
                    previewFilename.textContent = file.name;
                    previewContainer.style.display = 'block';
                }
                
                reader.readAsDataURL(file);
            }
        });

        // Cancel image preview
        cancelPreview.addEventListener('click', function() {
            imageInput.value = '';
            previewContainer.style.display = 'none';
            previewImage.src = '';
            previewFilename.textContent = '';
        });

        chatSocket.onmessage = function(e) {
            const data = JSON.parse(e.data);

            if (data.type === "online_count") {
                document.getElementById("presence-count").textContent = "Online: " + data.count;
                return;
            }

            // Create message element
            const msgDiv = document.createElement("div");
            msgDiv.classList.add("message");
            
            // Check if this message is from the current user
            if (data.username === "{{ request.user.username }}") {
                msgDiv.classList.add("sent");
            } else {
                msgDiv.classList.add("received");
            }

            // Create message header
            const messageHeader = document.createElement("div");
            messageHeader.classList.add("message-header");
            
            const username = document.createElement("span");
            username.classList.add("username");
            username.textContent = data.username || "Anon";
            messageHeader.appendChild(username);

            if (data.timestamp) {
                const time = document.createElement("span");
                time.classList.add("timestamp");
                time.textContent = data.timestamp;
                messageHeader.appendChild(time);
            }
            
            msgDiv.appendChild(messageHeader);

            // Create message content
            const messageContent = document.createElement("div");
            messageContent.classList.add("message-content");

            if (data.text) {
                const textNode = document.createTextNode(data.text);
                messageContent.appendChild(textNode);
            }

            if (data.image_url) {
                const imgContainer = document.createElement("div");
                imgContainer.classList.add("message-image");
                
                const img = document.createElement("img");
                img.src = data.image_url;
                imgContainer.appendChild(img);
                
                messageContent.appendChild(imgContainer);
            }

            msgDiv.appendChild(messageContent);
            
            // Add status indicator for sent messages
            if (data.username === "{{ request.user.username }}") {
                const messageStatus = document.createElement("div");
                messageStatus.classList.add("message-status");
                messageStatus.innerHTML = '<i class="fas fa-check-double"></i>';
                msgDiv.appendChild(messageStatus);
            }

            messagesDiv.appendChild(msgDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
            
            // Clear image preview after sending
            if (data.image_url && data.username === "{{ request.user.username }}") {
                previewContainer.style.display = 'none';
                previewImage.src = '';
                previewFilename.textContent = '';
                imageInput.value = '';
            }
        };

        // Handle sending messages
        form.addEventListener("submit", async function(e) {
            e.preventDefault();
            const text = input.value;
            let image = null;

            if (imageInput.files.length > 0) {
                const file = imageInput.files[0];
                image = await toBase64(file);
            }

            if (text.trim() !== '' || image) {
                chatSocket.send(JSON.stringify({
                    text: text,
                    image: image
                }));

                input.value = "";
                input.style.height = 'auto';
                
                // Save scroll position
                localStorage.setItem('chatScrollPosition', messagesDiv.scrollTop);
            }
        });

        // Convert file to base64
        function toBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve(reader.result);
                reader.onerror = error => reject(error);
            });
        }
    </script>
</body>
</html>